[tox]
envlist =
    py310-rarfile40-py7zr0220,
    py310-rarfile42-py7zr100rc3,
    py310-alldeps,
    py311-alldeps,
    py312-alldeps,
    py313-alldeps,
    py314beta-alldeps,
    latest-alldeps,
    py310-rarfilenotinstalled-py7zrnotinstalled,
    py310-missing-crypto
skip_missing_interpreters = True

[testenv]
deps =
    pytest
    # Factor definitions for compression libraries
    compression: lz4>=4.4.4       # For test collection/sample_archives.py if not covered by .
    compression: zstandard>=0.23.0  # For test collection/sample_archives.py if not covered by .
    # Factor definitions for rarfile versions
    rarfile40: rarfile==4.0
    rarfile42: rarfile==4.2
    rarfilelatest: rarfile
    # Factor definitions for py7zr versions
    py7zr0220: py7zr==0.22.0
    py7zr100rc3: py7zr==1.0.0rc3
    py7zrlatest: py7zr
    # Factors for special cases
    rarfilenotinstalled: # Used by py310-rarfilenotinstalled-py7zrnotinstalled
    py7zrnotinstalled:   # Used by py310-rarfilenotinstalled-py7zrnotinstalled
    missing-crypto:      # Used by py310-missing-crypto
    # Factor for all latest dependencies
    alldeps: .[optional]
    alldeps: rarfile
    alldeps: py7zr
    alldeps: lz4>=4.4.4
    alldeps: zstandard>=0.23.0
commands =
    sh -c 'if ! command -v unrar >/dev/null; then \
        echo "⚠️  'unrar' is not installed. Installing it requires sudo access."; \
        echo "⏳  Enter your password if prompted."; \
        sudo apt-get update && sudo apt-get install -y unrar; \
    else \
        echo "✅  'unrar' is already installed."; \
    fi'
    pytest -m "not missing_crypto and not missing_rarfile and not missing_py7zr" tests/archivey/test_read_archives.py
setenv =
    PYTHONPATH = {toxinidir}/src
passenv = *
allowlist_externals =
    sudo
    apt-get
    sh

# Specific environment configurations

[testenv:py310-rarfile40-py7zr0220]
deps =
    .
    # Factors rarfile40 and py7zr0220 from [testenv] apply automatically

[testenv:py310-rarfile42-py7zr100rc3]
deps =
    .[optional]
    # Factors rarfile42 and py7zr100rc3 from [testenv] apply automatically

[testenv:py310-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:py311-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:py312-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:py313-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:py314beta-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:latest-alldeps]
deps =
    # alldeps factor from [testenv] applies automatically

[testenv:py310-rarfilenotinstalled-py7zrnotinstalled]
deps =
    # Factors rarfilenotinstalled and py7zrnotinstalled from [testenv] apply automatically
    # compression factor from [testenv] applies automatically
commands =
    pytest -m "missing_rarfile or missing_py7zr" tests/archivey/test_read_archives.py

[testenv:py310-missing-crypto]
deps =
    .                  # Install the package itself
    rarfile            # rarfile is needed for the crypto tests (it's mocked as missing crypto features)
    # compression factor from [testenv] applies automatically
    # Factor missing-crypto from [testenv] applies automatically
commands =
    pytest -m missing_crypto tests/archivey/test_read_archives.py
