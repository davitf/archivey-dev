[tox]
envlist =
    py310-rarfile40-py7zr0220,
    py310-rarfile42-py7zr100rc3,
    py310-rarfilelatest-py7zrlatest,
    py311-rarfilelatest-py7zrlatest,
    py312-rarfilelatest-py7zrlatest,
    py313-rarfilelatest-py7zrlatest,
    py314beta-rarfilelatest-py7zrlatest,
    latest-rarfilelatest-py7zrlatest,
    py310-rarfilenotinstalled-py7zrnotinstalled,
    py310-missing-crypto
skip_missing_interpreters = True

[testenv]
deps =
    # Factor definitions for rarfile versions
    rarfile40: rarfile==4.0
    rarfile42: rarfile==4.2
    rarfilelatest: rarfile
    # Factor definitions for py7zr versions
    py7zr0220: py7zr==0.22.0
    py7zr100rc3: py7zr==1.0.0rc3
    py7zrlatest: py7zr
    # Factors for special cases
    rarfilenotinstalled: # Used by py310-rarfilenotinstalled-py7zrnotinstalled
    py7zrnotinstalled:   # Used by py310-rarfilenotinstalled-py7zrnotinstalled
    missing-crypto:      # Used by py310-missing-crypto
commands =
    # Note: sudo apt-get update is run once per job in GHA now,
    # but keeping it here for local tox runs if needed.
    sudo apt-get update
    sudo apt-get install -y unrar
    pytest -m "not missing_crypto and not missing_rarfile and not missing_py7zr" tests/archivey/test_read_archives.py
setenv =
    PYTHONPATH = {toxinidir}/src
passenv = *
allowlist_externals =
    sudo
    apt-get

# Specific environment configurations

[testenv:py310-rarfile40-py7zr0220]
deps =
    .
    pytest
    lz4>=4.4.4
    zstandard>=0.23.0
    rarfile40  # Factor for rarfile==4.0
    py7zr0220  # Factor for py7zr==0.22.0

[testenv:py310-rarfile42-py7zr100rc3]
deps =
    .[optional]
    pytest
    rarfile42      # Factor for rarfile==4.2
    py7zr100rc3    # Factor for py7zr==1.0.0rc3

[testenv:py310-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest  # Factor for latest rarfile
    py7zrlatest    # Factor for latest py7zr

[testenv:py311-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest
    py7zrlatest

[testenv:py312-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest
    py7zrlatest

[testenv:py313-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest
    py7zrlatest

[testenv:py314beta-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest
    py7zrlatest

[testenv:latest-rarfilelatest-py7zrlatest]
deps =
    .[optional]
    pytest
    rarfilelatest
    py7zrlatest

[testenv:py310-rarfilenotinstalled-py7zrnotinstalled]
deps =
    pytest
    lz4>=4.4.4       # For test collection/sample_archives.py
    zstandard>=0.23.0  # For test collection/sample_archives.py
    rarfilenotinstalled # Factor to ensure no rarfile installed by deps
    py7zrnotinstalled   # Factor to ensure no py7zr installed by deps
commands =
    pytest -m "missing_rarfile or missing_py7zr" tests/archivey/test_read_archives.py

[testenv:py310-missing-crypto]
deps =
    .                  # Install the package itself
    pytest
    rarfile            # rarfile is needed for the crypto tests (it's mocked as missing crypto features)
    lz4>=4.4.4       # For test collection/sample_archives.py
    zstandard>=0.23.0  # For test collection/sample_archives.py
    missing-crypto     # Factor for this environment
commands =
    pytest -m missing_crypto tests/archivey/test_read_archives.py
